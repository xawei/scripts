#!/bin/bash

# Configurable variables
REGION="ap-southeast-1"   # Singapore region
PROFILE="your-profile-name"  # AWS CLI profile name
TMP_KUBECONFIG="/tmp/tmp_kubeconfig"

DEPLOYMENT_NAME="your-deployment-name"
NAMESPACE="default"

# Get list of all EKS clusters for this profile
clusters=$(aws eks list-clusters --region "$REGION" --profile "$PROFILE" --output text --query 'clusters[]')

for cluster in $clusters; do
  echo "==> Checking cluster: $cluster"

  # Update kubeconfig using profile
  aws eks update-kubeconfig \
    --region "$REGION" \
    --name "$cluster" \
    --kubeconfig "$TMP_KUBECONFIG" \
    --profile "$PROFILE" \
    > /dev/null

  # Run kubectl command
  image=$(kubectl --kubeconfig "$TMP_KUBECONFIG" -n "$NAMESPACE" get deployment "$DEPLOYMENT_NAME" \
    -o jsonpath='{.spec.template.spec.containers[*].image}' 2>/dev/null)

  if [ $? -eq 0 ]; then
    echo "Cluster: $cluster - Image: $image"
  else
    echo "Cluster: $cluster - Deployment '$DEPLOYMENT_NAME' not found or error occurred."
  fi

  echo ""
done

# Cleanup
rm -f "$TMP_KUBECONFIG"